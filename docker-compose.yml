# Base Backend configuration
x-backend: &backend
  build: .
  restart: always
  env_file:
    - .env
  depends_on:
    db:
      condition: service_healthy
      restart: true
    redis:
      condition: service_healthy
      restart: true
  volumes:
    - static_data:/src/staticfiles
  healthcheck:
    test: ["CMD-SHELL", "curl -fsS http://localhost:8000/health/ "]
    interval: 5s
    timeout: 10s
    retries: 5

# Base Nginx configuration
x-nginx: &nginx
  build:
    context: ./nginx
  restart: always
  ports:
    - 80:80
  volumes:
    - static_data:/app/static
  healthcheck:
    test: ["CMD-SHELL", "curl -fsS --out-null http://localhost:8080/health"]
    interval: 5s
    timeout: 10s
    retries: 5


services:

  db:
    image: postgres:16.3-alpine
    restart: always
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./.pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles: [dev, stage, prod]

  redis:
    image: redis:7.2-alpine
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./.redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles: [dev, stage, prod]


  # ===================================DEVELOPMENT SERVICES===================================
  backend-dev:
    <<: *backend
    build:
      args:
        DEV: true
    environment:
      - DJANGO_ALLOWED_HOSTS=backend-dev
      - DJANGO_SETTINGS_MODULE=main.django.development
    profiles: [dev]

  nginx-dev:
    <<: *nginx
    environment:
      - BACKEND_HOSTNAME=backend-dev
    depends_on:
      backend-dev:
        condition: service_healthy
    profiles: [dev]

  # ===============================PRODUCTION and STAGE SERVICES===============================

  backend-prod:
    <<: *backend
    environment:
      - DJANGO_ALLOWED_HOSTS=backend-prod
      - DJANGO_SETTINGS_MODULE=main.django.production
    profiles: [prod, stage]

  nginx-prod:
    <<: *nginx
    profiles: [prod, stage]
    environment:
      - BACKEND_HOSTNAME=backend-prod
    depends_on:
      backend-prod:
        condition: service_healthy

volumes:
  static_data:
